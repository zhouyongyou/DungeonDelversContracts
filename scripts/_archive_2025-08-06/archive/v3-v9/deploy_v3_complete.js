// scripts/deploy_v3_complete.js
// ÂÆåÊï¥ÁöÑ V3 ÁâàÊú¨ÈÉ®ÁΩ≤ËÖ≥Êú¨

const hre = require("hardhat");
const fs = require('fs');
const path = require('path');

// È°èËâ≤Ëº∏Âá∫
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  cyan: '\x1b[36m',
  magenta: '\x1b[35m'
};

// Êó•Ë™åÂáΩÊï∏
function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

// ‰øùÂ≠òÈÉ®ÁΩ≤Âú∞ÂùÄ
function saveDeployment(contractName, address, network) {
  const deploymentsDir = path.join(__dirname, '..', 'deployments');
  if (!fs.existsSync(deploymentsDir)) {
    fs.mkdirSync(deploymentsDir);
  }
  
  const networkDir = path.join(deploymentsDir, network);
  if (!fs.existsSync(networkDir)) {
    fs.mkdirSync(networkDir);
  }
  
  const deploymentFile = path.join(networkDir, `${contractName}.json`);
  const deployment = {
    address: address,
    deployedAt: new Date().toISOString(),
    network: network,
    contractName: contractName
  };
  
  fs.writeFileSync(deploymentFile, JSON.stringify(deployment, null, 2));
}

// ‰øùÂ≠òÊâÄÊúâÂú∞ÂùÄÂà∞‰∏ÄÂÄãÊñá‰ª∂
function saveAllAddresses(addresses, network) {
  const deploymentsDir = path.join(__dirname, '..', 'deployments');
  const allAddressesFile = path.join(deploymentsDir, `${network}_all_addresses.json`);
  
  const timestamp = new Date().toISOString();
  const data = {
    network: network,
    deployedAt: timestamp,
    addresses: addresses
  };
  
  fs.writeFileSync(allAddressesFile, JSON.stringify(data, null, 2));
  
  // ÂêåÊôÇÂâµÂª∫ .env Ê†ºÂºèÁöÑÊñá‰ª∂
  const envFile = path.join(deploymentsDir, `${network}_addresses.env`);
  let envContent = `# DungeonDelvers V3 Deployment Addresses\n`;
  envContent += `# Network: ${network}\n`;
  envContent += `# Deployed at: ${timestamp}\n\n`;
  
  Object.entries(addresses).forEach(([key, value]) => {
    envContent += `${key}=${value}\n`;
  });
  
  fs.writeFileSync(envFile, envContent);
}

async function main() {
  log('\nüöÄ Starting DungeonDelvers V3 Complete Deployment', 'bright');
  log('================================================\n', 'bright');
  
  const network = hre.network.name;
  log(`üìç Network: ${network}`, 'cyan');
  
  const [deployer] = await ethers.getSigners();
  log(`üë§ Deployer: ${deployer.address}`, 'cyan');
  
  const balance = await deployer.provider.getBalance(deployer.address);
  log(`üí∞ Balance: ${ethers.formatEther(balance)} BNB\n`, 'cyan');
  
  const addresses = {};
  
  try {
    // ============ Phase 1: Deploy Infrastructure ============
    log('\nüì¶ Phase 1: Deploying Infrastructure Contracts', 'yellow');
    log('----------------------------------------', 'yellow');
    
    // 2. Deploy SoulShard Token (ÈúÄË¶ÅÂÖàÈÉ®ÁΩ≤ÊâçËÉΩÁµ¶ Oracle)
    log('\n1Ô∏è‚É£  Deploying SoulShard Token...', 'magenta');
    const SoulShard = await ethers.getContractFactory("Test_SoulShard");
    const soulShard = await SoulShard.deploy(deployer.address);
    await soulShard.waitForDeployment();
    addresses.SOULSHARD_ADDRESS = soulShard.address;
    saveDeployment('SoulShard', soulShard.address, network);
    log(`‚úÖ SoulShard deployed at: ${soulShard.address}`, 'green');
    
    // 1. Deploy Oracle (‰ΩøÁî®ÁèæÊúâÁöÑÂú∞ÂùÄ)
    log('\n2Ô∏è‚É£  Deploying Oracle...', 'magenta');
    const Oracle = await ethers.getContractFactory("Oracle");
    const oracle = await Oracle.deploy(
      "0x737c5b0430d5aeb104680460179aaa38608b6169", // POOL_ADDRESS from .env
      soulShard.address, // SoulShard token
      "0x7C67Af4EBC6651c95dF78De11cfe325660d935FE"  // USD_TOKEN_ADDRESS from .env
    );
    await oracle.deployed();
    addresses.ORACLE_ADDRESS = oracle.address;
    saveDeployment('Oracle', oracle.address, network);
    log(`‚úÖ Oracle deployed at: ${oracle.address}`, 'green');
    
    
    // ============ Phase 2: Deploy Storage Contracts ============
    log('\nüì¶ Phase 2: Deploying Storage Contracts', 'yellow');
    log('----------------------------------------', 'yellow');
    
    // 3. Deploy DungeonStorage
    log('\n3Ô∏è‚É£  Deploying DungeonStorage...', 'magenta');
    const DungeonStorage = await ethers.getContractFactory("DungeonStorage");
    const dungeonStorage = await DungeonStorage.deploy(deployer.address);
    await dungeonStorage.deployed();
    addresses.DUNGEONSTORAGE_ADDRESS = dungeonStorage.address;
    saveDeployment('DungeonStorage', dungeonStorage.address, network);
    log(`‚úÖ DungeonStorage deployed at: ${dungeonStorage.address}`, 'green');
    
    // ============ Phase 3: Deploy NFT Contracts ============
    log('\nüì¶ Phase 3: Deploying NFT Contracts', 'yellow');
    log('----------------------------------------', 'yellow');
    
    // 4. Deploy Hero NFT
    log('\n4Ô∏è‚É£  Deploying Hero NFT...', 'magenta');
    const Hero = await ethers.getContractFactory("Hero");
    const hero = await Hero.deploy(deployer.address);
    await hero.deployed();
    addresses.HERO_ADDRESS = hero.address;
    saveDeployment('Hero', hero.address, network);
    log(`‚úÖ Hero deployed at: ${hero.address}`, 'green');
    
    // 5. Deploy Relic NFT
    log('\n5Ô∏è‚É£  Deploying Relic NFT...', 'magenta');
    const Relic = await ethers.getContractFactory("Relic");
    const relic = await Relic.deploy(deployer.address);
    await relic.deployed();
    addresses.RELIC_ADDRESS = relic.address;
    saveDeployment('Relic', relic.address, network);
    log(`‚úÖ Relic deployed at: ${relic.address}`, 'green');
    
    // 6. Deploy Party V3 NFT
    log('\n6Ô∏è‚É£  Deploying Party V3 NFT...', 'magenta');
    const Party = await ethers.getContractFactory("Party");
    const partyV3 = await Party.deploy(deployer.address);
    await partyV3.deployed();
    addresses.PARTY_ADDRESS = partyV3.address;
    saveDeployment('Party', partyV3.address, network);
    log(`‚úÖ Party V3 deployed at: ${partyV3.address}`, 'green');
    
    // ============ Phase 4: Deploy Game Mechanics ============
    log('\nüì¶ Phase 4: Deploying Game Mechanics', 'yellow');
    log('----------------------------------------', 'yellow');
    
    // 7. Deploy PlayerVault
    log('\n7Ô∏è‚É£  Deploying PlayerVault...', 'magenta');
    const PlayerVault = await ethers.getContractFactory("PlayerVault");
    const playerVault = await PlayerVault.deploy(deployer.address);
    await playerVault.deployed();
    addresses.PLAYERVAULT_ADDRESS = playerVault.address;
    saveDeployment('PlayerVault', playerVault.address, network);
    log(`‚úÖ PlayerVault deployed at: ${playerVault.address}`, 'green');
    
    // 8. Deploy PlayerProfile
    log('\n8Ô∏è‚É£  Deploying PlayerProfile...', 'magenta');
    const PlayerProfile = await ethers.getContractFactory("PlayerProfile");
    const playerProfile = await PlayerProfile.deploy(deployer.address);
    await playerProfile.deployed();
    addresses.PLAYERPROFILE_ADDRESS = playerProfile.address;
    saveDeployment('PlayerProfile', playerProfile.address, network);
    log(`‚úÖ PlayerProfile deployed at: ${playerProfile.address}`, 'green');
    
    // 9. Deploy AltarOfAscension
    log('\n9Ô∏è‚É£  Deploying AltarOfAscension...', 'magenta');
    const AltarOfAscension = await ethers.getContractFactory("AltarOfAscension");
    const altarOfAscension = await AltarOfAscension.deploy(deployer.address);
    await altarOfAscension.deployed();
    addresses.ALTAROFASCENSION_ADDRESS = altarOfAscension.address;
    saveDeployment('AltarOfAscension', altarOfAscension.address, network);
    log(`‚úÖ AltarOfAscension deployed at: ${altarOfAscension.address}`, 'green');
    
    // 10. Deploy VIPStaking
    log('\nüîü Deploying VIPStaking...', 'magenta');
    const VIPStaking = await ethers.getContractFactory("VIPStaking");
    const vipStaking = await VIPStaking.deploy(deployer.address);
    await vipStaking.deployed();
    addresses.VIPSTAKING_ADDRESS = vipStaking.address;
    saveDeployment('VIPStaking', vipStaking.address, network);
    log(`‚úÖ VIPStaking deployed at: ${vipStaking.address}`, 'green');
    
    // ============ Phase 5: Deploy Core Contracts ============
    log('\nüì¶ Phase 5: Deploying Core Contracts', 'yellow');
    log('----------------------------------------', 'yellow');
    
    // 11. Deploy DungeonCore
    log('\n1Ô∏è‚É£ 1Ô∏è‚É£  Deploying DungeonCore...', 'magenta');
    const DungeonCore = await ethers.getContractFactory("DungeonCore");
    const dungeonCore = await DungeonCore.deploy(deployer.address);
    await dungeonCore.deployed();
    addresses.DUNGEONCORE_ADDRESS = dungeonCore.address;
    saveDeployment('DungeonCore', dungeonCore.address, network);
    log(`‚úÖ DungeonCore deployed at: ${dungeonCore.address}`, 'green');
    
    // 12. Deploy DungeonMaster V7
    log('\n1Ô∏è‚É£ 2Ô∏è‚É£  Deploying DungeonMaster V7...', 'magenta');
    const DungeonMasterV7 = await ethers.getContractFactory("DungeonMasterV7");
    const dungeonMasterV7 = await DungeonMasterV7.deploy(deployer.address);
    await dungeonMasterV7.deployed();
    addresses.DUNGEONMASTER_ADDRESS = dungeonMasterV7.address;
    saveDeployment('DungeonMasterV7', dungeonMasterV7.address, network);
    log(`‚úÖ DungeonMaster V7 deployed at: ${dungeonMasterV7.address}`, 'green');
    
    // DungeonMaster Wallet (‰øùÊåÅ‰∏çËÆä)
    addresses.DUNGEONMASTERWALLET_ADDRESS = "0xEbCF4A36Ad1485A9737025e9d72186b604487274";
    
    // ============ Phase 6: Setup Connections ============
    log('\nüîó Phase 6: Setting up Contract Connections', 'yellow');
    log('----------------------------------------', 'yellow');
    
    // Ë®≠ÁΩÆ DungeonCore ‰∏≠ÁöÑÊâÄÊúâÂú∞ÂùÄ
    log('\nüîó Setting up DungeonCore addresses...', 'cyan');
    
    await dungeonCore.setOracle(oracle.address);
    log('  ‚úÖ Oracle set');
    
    await dungeonCore.setSoulShardToken(soulShard.address);
    log('  ‚úÖ SoulShard token set');
    
    await dungeonCore.setHeroContract(hero.address);
    log('  ‚úÖ Hero contract set');
    
    await dungeonCore.setRelicContract(relic.address);
    log('  ‚úÖ Relic contract set');
    
    await dungeonCore.setPartyContract(partyV3.address);
    log('  ‚úÖ Party V3 contract set');
    
    await dungeonCore.setPlayerVault(playerVault.address);
    log('  ‚úÖ PlayerVault set');
    
    await dungeonCore.setPlayerProfile(playerProfile.address);
    log('  ‚úÖ PlayerProfile set');
    
    await dungeonCore.setVIPStaking(vipStaking.address);
    log('  ‚úÖ VIPStaking set');
    
    // Ë®≠ÁΩÆÂêÑÂÄãÂêàÁ¥ÑÁöÑ DungeonCore Âú∞ÂùÄ
    log('\nüîó Setting DungeonCore in all contracts...', 'cyan');
    
    await hero.setDungeonCore(dungeonCore.address);
    log('  ‚úÖ Hero -> DungeonCore');
    
    await relic.setDungeonCore(dungeonCore.address);
    log('  ‚úÖ Relic -> DungeonCore');
    
    await partyV3.setDungeonCore(dungeonCore.address);
    log('  ‚úÖ Party V3 -> DungeonCore');
    
    await playerVault.setDungeonCore(dungeonCore.address);
    log('  ‚úÖ PlayerVault -> DungeonCore');
    
    await playerProfile.setDungeonCore(dungeonCore.address);
    log('  ‚úÖ PlayerProfile -> DungeonCore');
    
    await altarOfAscension.setDungeonCore(dungeonCore.address);
    log('  ‚úÖ AltarOfAscension -> DungeonCore');
    
    await vipStaking.setDungeonCore(dungeonCore.address);
    log('  ‚úÖ VIPStaking -> DungeonCore');
    
    await dungeonMasterV7.setDungeonCore(dungeonCore.address);
    log('  ‚úÖ DungeonMaster V7 -> DungeonCore');
    
    // Ë®≠ÁΩÆ DungeonMaster ÁöÑÈ°çÂ§ñÈÄ£Êé•
    log('\nüîó Setting up DungeonMaster V7 connections...', 'cyan');
    
    await dungeonMasterV7.setDungeonStorage(dungeonStorage.address);
    log('  ‚úÖ DungeonStorage set');
    
    await dungeonMasterV7.setSoulShardToken(soulShard.address);
    log('  ‚úÖ SoulShard token set');
    
    // Ë®≠ÁΩÆ Party V3 ÁöÑÂêàÁ¥ÑÈÄ£Êé•
    log('\nüîó Setting up Party V3 connections...', 'cyan');
    
    await partyV3.setHeroContract(hero.address);
    log('  ‚úÖ Hero contract set');
    
    await partyV3.setRelicContract(relic.address);
    log('  ‚úÖ Relic contract set');
    
    // ============ Phase 7: Initialize Game Data ============
    log('\nüéÆ Phase 7: Initializing Game Data', 'yellow');
    log('----------------------------------------', 'yellow');
    
    // ÂàùÂßãÂåñÂú∞ÂüéÊï∏Êìö
    log('\nüè∞ Initializing dungeons...', 'cyan');
    
    const dungeons = [
      { id: 1, requiredPower: 100, rewardUSD: 10e18, successRate: 80 },
      { id: 2, requiredPower: 300, rewardUSD: 30e18, successRate: 70 },
      { id: 3, requiredPower: 600, rewardUSD: 60e18, successRate: 60 },
      { id: 4, requiredPower: 1000, rewardUSD: 100e18, successRate: 50 },
      { id: 5, requiredPower: 1500, rewardUSD: 150e18, successRate: 40 }
    ];
    
    for (const dungeon of dungeons) {
      await dungeonMasterV7.adminSetDungeon(
        dungeon.id,
        dungeon.requiredPower,
        dungeon.rewardUSD,
        dungeon.successRate
      );
      log(`  ‚úÖ Dungeon ${dungeon.id} initialized (Power: ${dungeon.requiredPower})`);
    }
    
    // Ë®≠ÁΩÆÊéàÊ¨äÊìç‰ΩúÂì°
    log('\nüë• Setting up operator approvals...', 'cyan');
    
    await dungeonStorage.addAuthorizedOperator(dungeonMasterV7.address);
    log('  ‚úÖ DungeonMaster V7 authorized as DungeonStorage operator');
    
    // ============ Save Deployment Info ============
    log('\nüíæ Saving deployment information...', 'yellow');
    saveAllAddresses(addresses, network);
    
    // ============ Deployment Summary ============
    log('\n' + '='.repeat(60), 'bright');
    log('üéâ DEPLOYMENT COMPLETED SUCCESSFULLY! üéâ', 'bright');
    log('='.repeat(60) + '\n', 'bright');
    
    log('üìã Contract Addresses:', 'green');
    log('---------------------', 'green');
    
    Object.entries(addresses).forEach(([name, address]) => {
      log(`${name}: ${address}`, 'cyan');
    });
    
    log('\nüìÅ Deployment files saved to:', 'yellow');
    log(`  - deployments/${network}_all_addresses.json`, 'yellow');
    log(`  - deployments/${network}_addresses.env`, 'yellow');
    
    log('\n‚ö° Next Steps:', 'magenta');
    log('  1. Verify contracts on BSCScan', 'magenta');
    log('  2. Update frontend configuration', 'magenta');
    log('  3. Update backend configuration', 'magenta');
    log('  4. Deploy subgraph', 'magenta');
    
  } catch (error) {
    log('\n‚ùå Deployment failed!', 'red');
    log(`Error: ${error.message}`, 'red');
    throw error;
  }
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });