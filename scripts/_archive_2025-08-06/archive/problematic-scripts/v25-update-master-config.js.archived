const fs = require('fs');
const path = require('path');
const chalk = require('chalk');

// V25 æ­£ç¢ºçš„åˆç´„åœ°å€ï¼ˆ2025-08-03 éƒ¨ç½²ï¼‰
const V25_ADDRESSES = {
  // æ ¸å¿ƒåˆç´„
  ORACLE_ADDRESS: "0xdbf49cd5708C56b8b0848233b754b418806D7018",
  DUNGEONCORE_ADDRESS: "0x2953ed03825b40e9c1EBa1cAe5FBD47f20A4823d",
  
  // éŠæˆ²æ©Ÿåˆ¶åˆç´„
  PLAYERVAULT_ADDRESS: "0x7085b353f553225B6001Ba23ECCb39611fBa31Bf",
  PLAYERPROFILE_ADDRESS: "0x481ABDF19E41Bf2cE84075174675626aa027fE82",
  VIPSTAKING_ADDRESS: "0xC0D8C84e28E5BcfC9cBD109551De53BA04e7328C",
  DUNGEONSTORAGE_ADDRESS: "0x22bbcF5411c991A5DE7774Ace435DcBF69EF0a8a",
  DUNGEONMASTER_ADDRESS: "0x9e17c01A610618223d49D64E322DC1b6360E4E8D",
  ALTAROFASCENSION_ADDRESS: "0xB102a57eD4697f7A721541fd7B0bba8D6bdF63a5",
  
  // NFT åˆç´„
  HERO_ADDRESS: "0x001b7462B0f1Ab832c017a6f09133932Be140b18",
  RELIC_ADDRESS: "0xdd8E52cD1d248D04C306c038780315a03866B402",
  PARTY_ADDRESS: "0x382024850E08AB37E290315fc5f3692b8D6646EB",
  
  // è¤‡ç”¨çš„åˆç´„
  SOULSHARD_ADDRESS: "0x97B2C2a9A11C7b6A020b4bAEaAd349865eaD0bcF",
  UNISWAP_POOL_ADDRESS: "0x1e5Cd5F386Fb6F39cD8788675dd3A5ceB6521C82",
  USD_TOKEN_ADDRESS: "0x7C67Af4EBC6651c95dF78De11cfe325660d935FE",
  DUNGEONMASTERWALLET_ADDRESS: "0x10925A7138649C7E1794CE646182eeb5BF8ba647"
};

async function updateMasterConfig() {
  console.log(chalk.cyan('\n=================================================='));
  console.log(chalk.cyan('ğŸ”„ æ›´æ–° master-config.json ç‚º V25 åœ°å€'));
  console.log(chalk.cyan('==================================================\n'));
  
  const masterConfigPath = path.join(__dirname, '../../config/master-config.json');
  
  // å‚™ä»½ç¾æœ‰é…ç½®
  if (fs.existsSync(masterConfigPath)) {
    const backupPath = masterConfigPath + '.backup-' + Date.now();
    fs.copyFileSync(masterConfigPath, backupPath);
    console.log(chalk.green(`âœ… å·²å‚™ä»½åˆ°: ${backupPath}`));
  }
  
  // è®€å–ç¾æœ‰é…ç½®æˆ–å‰µå»ºæ–°çš„
  let masterConfig;
  if (fs.existsSync(masterConfigPath)) {
    masterConfig = JSON.parse(fs.readFileSync(masterConfigPath, 'utf8'));
  } else {
    masterConfig = {
      version: "1.0.0",
      lastUpdated: new Date().toISOString(),
      network: {
        name: "BSC Mainnet",
        chainId: 56,
        rpcUrl: "https://bsc-dataseed.binance.org/"
      },
      contracts: {
        mainnet: {},
        testnet: {}
      },
      subgraph: {
        version: "v3.5.6",
        endpoint: "https://api.thegraph.com/subgraphs/name/sotadic/dungeon-delvers"
      }
    };
  }
  
  // æ›´æ–°ä¸»ç¶²åœ°å€
  masterConfig.contracts.mainnet = {
    ...masterConfig.contracts.mainnet,
    ...V25_ADDRESSES
  };
  
  // æ›´æ–°ç‰ˆæœ¬å’Œæ™‚é–“
  masterConfig.version = "1.1.0";
  masterConfig.lastUpdated = new Date().toISOString();
  masterConfig.deploymentInfo = {
    v25: {
      date: "2025-08-03",
      startBlock: 56291866,
      deployer: V25_ADDRESSES.DUNGEONMASTERWALLET_ADDRESS,
      notes: [
        "Commit-Reveal æ©Ÿåˆ¶å¯¦æ–½",
        "çµ±ä¸€æ©Ÿç‡ç³»çµ±",
        "å¼·åˆ¶æ­ç¤ºå›ºå®šåˆ†å¸ƒ"
      ]
    }
  };
  
  // å¯«å…¥æ›´æ–°å¾Œçš„é…ç½®
  fs.writeFileSync(
    masterConfigPath,
    JSON.stringify(masterConfig, null, 2)
  );
  
  console.log(chalk.green('âœ… master-config.json å·²æ›´æ–°'));
  
  // é¡¯ç¤ºæ›´æ–°çš„åœ°å€
  console.log(chalk.yellow('\næ›´æ–°çš„åœ°å€:'));
  Object.entries(V25_ADDRESSES).forEach(([key, value]) => {
    console.log(`${key}: ${value}`);
  });
  
  // å‰µå»º .env.v25 æ–‡ä»¶
  const envContent = Object.entries(V25_ADDRESSES)
    .map(([key, value]) => `${key}=${value}`)
    .join('\n');
  
  const envPath = path.join(__dirname, '../../.env.v25');
  fs.writeFileSync(envPath, envContent);
  console.log(chalk.green(`\nâœ… å‰µå»º .env.v25 æ–‡ä»¶`));
  
  console.log(chalk.cyan('\nä¸‹ä¸€æ­¥:'));
  console.log('1. åŸ·è¡ŒåŒæ­¥è…³æœ¬: npm run sync:v25');
  console.log('2. éƒ¨ç½²å­åœ–: cd subgraph && ./deploy.sh v3.5.6');
  console.log('3. æ›´æ–°å‰ç«¯é…ç½®');
  console.log('4. æ›´æ–°å¾Œç«¯é…ç½®');
}

updateMasterConfig()
  .then(() => {
    console.log(chalk.green('\nâœ… é…ç½®æ›´æ–°å®Œæˆï¼'));
    process.exit(0);
  })
  .catch((error) => {
    console.error(chalk.red('\nâŒ æ›´æ–°å¤±æ•—:'), error);
    process.exit(1);
  });