# V25.1 最終配置 (2025-08-22)

## ✅ 已部署的合約地址

### 核心合約
- **DungeonCore**: `0x5B64A5939735Ff762493D9B9666b3e13118c5722`
- **VRF Manager**: `0xeCd92f6BA6E897F874216Db56C7De75CF928fd25` ✅ (新)
- **Oracle**: `0xEE322Eff70320759487f67875113C062AC1F4cfB`
- **SoulShard**: `0xB73FE158689EAB3396B64794b573D4BEc7113412`

### NFT 合約
- **Hero**: `0x27E3A73a4d7DDD8Dea6cBF9e152173CcC04b7505` ✅ (新)
- **Relic**: `0x8676174F82A9e5006B33976430D91d752fa90E3e` ✅ (新)
- **Party**: `0x495bcE2D9561E0f7623fF244e4BA28DCFfEe71d9`

### 遊戲合約
- **DungeonMaster**: `0xAAdE1919B2EA95cBBFcDEa41CBf9D48ae0d44cdF`
- **DungeonStorage**: `0xCE75345A01dB5c40E443624F86BDC45BabF7B6ec`
- **AltarOfAscension**: `0x56B62168734827b9b3D750ac1aB9F249e0a0EEd3`
- **PlayerVault**: `0x446a82f2003484Bdc83f29e094fcb66D01094db0`
- **PlayerProfile**: `0x3509d0f0cD6f7b518860f945128205ac4F426090`
- **VIPStaking**: `0x18d13f4FdE3245ABa6D0fb91597291e1F46b0661`

## 🔗 VRF 配置（永久固定）

```javascript
const VRF_CONFIG = {
    COORDINATOR: "0xd691f04bc0C9a24Edb78af9E005Cf85768F694C9",  // ✅ BSC Mainnet VRF Coordinator V2.5
    SUBSCRIPTION_ID: "88422796721004450630713121079263696788635490871993157345476848872165866246915", // ✅ 固定訂閱 ID
    KEY_HASH: "0x130dba50ad435d4ecc214aad0d5820474137bd68e7e77724144f27c3c377d3d4" // ✅ 200 gwei
};
```

## 📝 V25.1 修復記錄

### 修復的問題
1. **Hero/Relic VRF 調用參數錯誤**
   - 原因：傳遞 `1` 而不是 `_quantity`
   - 影響：VRF Manager 無法正確計算 Gas Limit
   - 解決：修正為傳遞實際鑄造數量

2. **VRF Manager 配置錯誤**
   - 原因：錯誤的 Coordinator 地址和訂閱 ID
   - 影響：無法成功請求隨機數
   - 解決：重新部署 VRF Manager with 正確配置

### 部署順序
1. ✅ 部署新的 Hero 合約
2. ✅ 部署新的 Relic 合約
3. ✅ 設定 Hero → DungeonCore
4. ✅ 設定 Relic → DungeonCore
5. ✅ 更新 DungeonCore → Hero/Relic
6. ✅ 部署新的 VRF Manager
7. ✅ 設定 VRF Manager → DungeonCore
8. ✅ 更新 DungeonCore → VRF Manager

## ⚠️ 重要提醒

### 必須完成的步驟
1. **添加 VRF Manager 為訂閱消費者**
   - 訪問: https://vrf.chain.link/bsc/88422796721004450630713121079263696788635490871993157345476848872165866246915
   - 添加消費者: `0xeCd92f6BA6E897F874216Db56C7De75CF928fd25`

2. **確保訂閱餘額充足**
   - 檢查 LINK 或 BNB 餘額
   - 建議至少保持 10 LINK 或等值 BNB

3. **更新配置文件**
   ```bash
   # 更新 .env.v25
   HERO_ADDRESS=0x27E3A73a4d7DDD8Dea6cBF9e152173CcC04b7505
   RELIC_ADDRESS=0x8676174F82A9e5006B33976430D91d752fa90E3e
   VRF_MANAGER_V2PLUS_ADDRESS=0xeCd92f6BA6E897F874216Db56C7De75CF928fd25
   
   # 同步到所有項目
   cd /Users/sotadic/Documents/DungeonDelversContracts
   node scripts/ultimate-config-system.js sync
   ```

## 📊 驗證清單

- [x] Hero → DungeonCore 連接正確
- [x] Relic → DungeonCore 連接正確
- [x] DungeonCore → Hero 地址正確
- [x] DungeonCore → Relic 地址正確
- [x] DungeonCore → VRF Manager 地址正確
- [x] VRF Manager → DungeonCore 連接正確
- [x] VRF Coordinator 地址正確
- [x] 訂閱 ID 正確
- [x] Key Hash 正確
- [ ] VRF Manager 已添加為訂閱消費者（需手動操作）
- [ ] 訂閱餘額充足（需檢查）

## 🚨 舊合約地址（已棄用）

- **舊 Hero**: `0x60bdCE3d1412C1aA8F18a58801895Bb0C3D45357`
- **舊 Relic**: `0xE80d9c0E6dA24f1C71C3A77E0565abc8bb139817`
- **舊 VRF Manager**: `0x0497108f4734BbC0381DF82e95A41e1425C53981`

## 交易記錄

1. Hero 部署: [BSCScan](https://bscscan.com/address/0x27E3A73a4d7DDD8Dea6cBF9e152173CcC04b7505)
2. Relic 部署: [BSCScan](https://bscscan.com/address/0x8676174F82A9e5006B33976430D91d752fa90E3e)
3. VRF Manager 部署: [BSCScan](https://bscscan.com/address/0xeCd92f6BA6E897F874216Db56C7De75CF928fd25)
4. 訂閱 ID 更新: `0xc283c8fa6f590027c392cb18a36f017befa61384b51ad4df7dc0c0984eb7f01d`
5. DungeonCore 更新: `0xa9f1b4e4d84bafee3fce21bf5f0fa086a439d1754a333a4510ebc7e7a1256530`