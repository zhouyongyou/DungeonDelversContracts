# 🎮 DungeonDelvers 地下城經驗值完整指南

## 📊 **官方經驗值規則**

### **核心計算公式** (來自 DungeonMaster.sol)
```solidity
// 成功遠征: 經驗值 = 地城需求戰力 ÷ 10
// 失敗遠征: 經驗值 = 地城需求戰力 ÷ 20
expGained = dungeon.requiredPower / (success ? 10 : 20);
```

### **等級計算公式** (來自 utils.ts)
```solidity
// 等級 = sqrt(總經驗值 ÷ 100) + 1
level = Math.sqrt(totalExperience / 100) + 1
```

## 🏰 **所有地下城詳細資料**

### **基礎地下城 (ID 1-10)**
| ID | 地下城名稱 | 需求戰力 | 獎勵USD | 基礎成功率 | 成功經驗值 | 失敗經驗值 |
|----|-----------|---------|---------|-----------|-----------|-----------|
| 1 | 新手礦洞 | 300 | $6 | 89% | **30 EXP** | **15 EXP** |
| 2 | 哥布林洞穴 | 600 | $12 | 84% | **60 EXP** | **30 EXP** |
| 3 | 食人魔山谷 | 900 | $20 | 79% | **90 EXP** | **45 EXP** |
| 4 | 蜘蛛巢穴 | 1200 | $33 | 74% | **120 EXP** | **60 EXP** |
| 5 | 石化蜥蜴沼澤 | 1500 | $52 | 69% | **150 EXP** | **75 EXP** |
| 6 | 巫妖墓穴 | 1800 | $78 | 64% | **180 EXP** | **90 EXP** |
| 7 | 奇美拉之巢 | 2100 | $113 | 59% | **210 EXP** | **105 EXP** |
| 8 | 惡魔前哨站 | 2400 | $156 | 54% | **240 EXP** | **120 EXP** |
| 9 | 巨龍之巔 | 2700 | $209 | 49% | **270 EXP** | **135 EXP** |
| 10 | 混沌深淵 | 3000 | $225 | 44% | **300 EXP** | **150 EXP** |

### **高階地下城 (ID 11-12)** ⚠️ 新增
| ID | 地下城名稱 | 需求戰力 | 獎勵USD | 基礎成功率 | 成功經驗值 | 失敗經驗值 |
|----|-----------|---------|---------|-----------|-----------|-----------|
| 11 | 冥界之門 | 3300 | $320 | 39% | **330 EXP** | **165 EXP** |
| 12 | 虛空裂隙 | 3600 | $450 | 34% | **360 EXP** | **180 EXP** |

## 🔴 **前端經驗值計算錯誤發現**

### **當前前端顯示 vs 實際應有值**
| 地下城 | 前端顯示 | 實際應有 | 錯誤 |
|-------|---------|---------|------|
| 新手礦洞 (300戰力) | +25 EXP | **+30 EXP** | ❌ -5 |
| 哥布林洞穴 (600戰力) | +30 EXP | **+60 EXP** | ❌ -30 |
| 食人魔山谷 (900戰力) | +35 EXP | **+90 EXP** | ❌ -55 |
| 蜘蛛巢穴 (1200戰力) | +40 EXP | **+120 EXP** | ❌ -80 |
| 石化蜥蜴沼澤 (1500戰力) | +45 EXP | **+150 EXP** | ❌ -105 |
| 巫妖墓穴 (1800戰力) | +50 EXP | **+180 EXP** | ❌ -130 |
| 奇美拉之巢 (2100戰力) | +55 EXP | **+210 EXP** | ❌ -155 |
| 惡魔前哨站 (2400戰力) | +60 EXP | **+240 EXP** | ❌ -180 |
| 巨龍之巔 (2700戰力) | +65 EXP | **+270 EXP** | ❌ -205 |
| 混沌深淵 (3000戰力) | +70 EXP | **+300 EXP** | ❌ -230 |
| 冥界之門 (3300戰力) | +75 EXP | **+330 EXP** | ❌ -255 |
| 虛空裂隙 (3600戰力) | +80 EXP | **+360 EXP** | ❌ -280 |

### **前端計算公式推測**
前端似乎使用了錯誤的公式：
```javascript
// ❌ 錯誤公式 (前端目前使用)
expGained = 20 + (dungeonId * 5)

// ✅ 正確公式 (應該使用)
expGained = requiredPower / 10  // 成功時
```

## 📈 **經驗值升級表**

### **升級所需總經驗值**
| 等級 | 總經驗值 | 從上級升級需要 | 等效成功遠征 |
|-----|---------|-------------|-------------|
| LV 1 | 0-99 | 0 | 起始等級 |
| LV 2 | 100-399 | 100 | 新手礦洞 x4次 |
| LV 3 | 400-899 | 300 | 新手礦洞 x10次 |
| LV 4 | 900-1599 | 500 | 新手礦洞 x17次 |
| LV 5 | 1600-2499 | 700 | 哥布林洞穴 x12次 |
| LV 10 | 8100-9999 | 1900 | 混沌深淵 x7次 |
| LV 20 | 39100-40999 | 1900 | 虛空裂隙 x6次 |

### **升級策略建議**
- **LV 1-3**: 新手礦洞 (最高效率)
- **LV 4-6**: 哥布林洞穴 + 食人魔山谷
- **LV 7-10**: 中階地城混合
- **LV 11+**: 高階地城衝等級

## 💰 **經驗值 vs 獎勵效率分析**

### **每美元獎勵的經驗值效率**
| 排名 | 地下城 | 經驗值/美元 | 評級 |
|-----|-------|-----------|------|
| 🥇 | 新手礦洞 | 5.00 | S級 |
| 🥇 | 哥布林洞穴 | 5.00 | S級 |
| 🥈 | 食人魔山谷 | 4.50 | A級 |
| 🥉 | 蜘蛛巢穴 | 3.64 | B級 |
| 4 | 石化蜥蜴沼澤 | 2.88 | C級 |
| 5 | 巫妖墓穴 | 2.31 | C級 |
| 6 | 奇美拉之巢 | 1.86 | D級 |
| 7 | 惡魔前哨站 | 1.54 | D級 |
| 8 | 巨龍之巔 | 1.29 | E級 |
| 9 | 混沌深淵 | 1.33 | E級 |
| 10 | 冥界之門 | 1.03 | F級 |
| 11 | 虛空裂隙 | 0.80 | F級 |

### **期望經驗值 (考慮成功率 + VIP等級)**
```
期望經驗值 = 成功經驗值 × (基礎成功率 + VIP加成) + 失敗經驗值 × (100% - 成功率)
```

| 地下城 | VIP 0 期望 | VIP 2 期望 | VIP 5 期望 |
|-------|-----------|-----------|-----------|
| 新手礦洞 | 28.35 | 28.95 | 30.00 |
| 哥布林洞穴 | 54.00 | 55.20 | 57.00 |
| 虛空裂隙 | 284.40 | 291.60 | 306.00 |

## 🎯 **最佳升級路線**

### **效率優先路線 (推薦新手)**
1. **LV 1-4**: 新手礦洞 (最高效率)
2. **LV 4-7**: 哥布林洞穴
3. **LV 7-10**: 食人魔山谷
4. **LV 10+**: 根據隊伍戰力選擇適合地城

### **收益優先路線 (推薦高戰力玩家)**
1. 直接挑戰能穩定通過的最高級地城
2. 平衡經驗值獲得和代幣收益
3. 虛空裂隙 = 最高經驗值 + 最高獎勵

## 🔧 **需要修復的問題**

### **1. 前端經驗值計算錯誤**
位置: `/src/pages/DungeonPage.tsx` 或相關計算文件
```javascript
// 需要找到並修復前端的經驗值計算邏輯
// 應該使用: requiredPower / 10 (成功) 或 requiredPower / 20 (失敗)
```

### **2. 合約常量更新**
```diff
// DungeonStorage.sol 第16行
- uint256 public constant NUM_DUNGEONS = 10;
+ uint256 public constant NUM_DUNGEONS = 12;
```

### **3. 子圖地城ID問題**
- 當前硬編碼為 dungeonId = 1
- 需要實施經驗值反推地城ID的解決方案

### **4. 子圖地城配置更新**
```typescript
// 需要在 dungeon-master.ts 中添加地城 11-12
const powerRequirements = [
  // ... 現有10個地城
  BigInt.fromI32(3300),  // 11 - 冥界之門
  BigInt.fromI32(3600)   // 12 - 虛空裂隙
]
```

## 📝 **總結**

- **經驗值計算**: 簡單明確的戰力除法公式
- **前端問題**: 計算公式錯誤，顯示值偏低
- **升級效率**: 低階地城效率最高
- **高階價值**: 絕對經驗值和獎勵最高
- **亟需修復**: 前端計算邏輯和子圖記錄問題