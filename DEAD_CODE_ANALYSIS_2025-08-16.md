# ğŸ” æ­»ä»£ç¢¼èˆ‡éºç•™åŠŸèƒ½å®Œæ•´åˆ†æå ±å‘Š
ç”Ÿæˆæ™‚é–“ï¼š2025-08-16

## ğŸ“Š éºç•™åŠŸèƒ½ç¸½è¦½

### 1. å·²è­˜åˆ¥çš„æ­»ä»£ç¢¼å’Œéºç•™åŠŸèƒ½

| åŠŸèƒ½é¡åˆ¥ | ä½ç½® | ç•¶å‰ç‹€æ…‹ | é¢¨éšªç­‰ç´š | å»ºè­°è™•ç† |
|---------|------|---------|----------|---------|
| **ç–²å‹åº¦ç³»çµ±** | DungeonStorage | å­—æ®µå­˜åœ¨ä½†æœªä½¿ç”¨ | ğŸŸ¡ ä¸­ | ä¿ç•™ï¼ˆæ•¸æ“šå…¼å®¹ï¼‰ |
| **å„²å‚™ç³»çµ±** | DungeonStorage | å­—æ®µå­˜åœ¨ä½†æœªä½¿ç”¨ | ğŸŸ¡ ä¸­ | ä¿ç•™ï¼ˆæ•¸æ“šå…¼å®¹ï¼‰ |
| **NFTæ­ç¤ºæ©Ÿåˆ¶** | Hero/Relic | isRevealedæ°¸é true | ğŸŸ¢ ä½ | å¯ç§»é™¤ï¼ˆV2ç‰ˆæœ¬ï¼‰ |
| **çå‹µé ˜å–** | DungeonMaster | æ°¸é revert | ğŸŸ¡ ä¸­ | ä¿ç•™ï¼ˆæ¥å£å…¼å®¹ï¼‰ |
| **æœªä½¿ç”¨åƒæ•¸** | å¤šå€‹åˆç´„ | ç·¨è­¯è­¦å‘Š | ğŸŸ¢ ä½ | å¯å„ªåŒ– |

---

## ğŸ” è©³ç´°åˆ†æ

### 1ï¸âƒ£ **ç–²å‹åº¦ç³»çµ±ï¼ˆFatigue Systemï¼‰**

#### ç•¶å‰ç‹€æ…‹
```solidity
// DungeonStorage.sol
struct PartyStatus {
    uint256 provisionsRemaining;  // âš ï¸ æœªä½¿ç”¨
    uint256 cooldownEndsAt;       // âœ… ä½¿ç”¨ä¸­
    uint256 unclaimedRewards;     // âš ï¸ æœªä½¿ç”¨
    uint8 fatigueLevel;           // âš ï¸ æœªä½¿ç”¨ - è¨»é‡‹èªªæ˜"å·²ç¶“ä¸å†ä½¿ç”¨çš„æ©Ÿåˆ¶"
}
```

#### å½±éŸ¿åˆ†æ
- **éˆä¸Šæ•¸æ“š**ï¼šå·²å­˜å„²çš„æ•¸æ“šç„¡æ³•åˆªé™¤ï¼Œå¿…é ˆä¿ç•™çµæ§‹
- **Gasæˆæœ¬**ï¼šè®€å–æ™‚æœƒæ¶ˆè€—é¡å¤–gasï¼ˆç´„200-500 gasï¼‰
- **è·¨åˆç´„èª¿ç”¨**ï¼šDungeonMasterä»åœ¨è®€å–é€™äº›å€¼ï¼ˆä½†æœªä½¿ç”¨ï¼‰

#### å»ºè­°è™•ç†æ–¹æ¡ˆ
```solidity
// æ–¹æ¡ˆAï¼šä¿ç•™ç¾ç‹€ï¼ˆæœ€å®‰å…¨ï¼‰âœ…
// ä¿æŒçµæ§‹ä¸è®Šï¼Œåƒ…åœ¨è¨»é‡‹ä¸­æ¨™è¨˜å»¢æ£„

// æ–¹æ¡ˆBï¼šå„ªåŒ–è®€å–ï¼ˆä¸­ç­‰é¢¨éšªï¼‰
function _getPartyStatus(uint256 _partyId) private view returns (PartyStatus memory) {
    (, uint256 cooldownEndsAt, , ) = dungeonStorage.partyStatuses(_partyId);
    return PartyStatus({
        cooldownEndsAt: cooldownEndsAt,
        unclaimedRewards: 0  // å§‹çµ‚è¿”å›0
    });
}

// æ–¹æ¡ˆCï¼šæ–°ç‰ˆæœ¬åˆç´„ï¼ˆéœ€è¦é·ç§»ï¼‰
// å‰µå»º DungeonStorageV2ï¼Œç§»é™¤æœªä½¿ç”¨å­—æ®µ
```

---

### 2ï¸âƒ£ **NFTæ­ç¤ºæ©Ÿåˆ¶ï¼ˆReveal Systemï¼‰**

#### ç•¶å‰ç‹€æ…‹
```solidity
// Hero.sol & Relic.sol
struct HeroData {
    uint8 rarity;
    uint256 power;
    bool isRevealed;  // âš ï¸ æ°¸é ç‚º true
}

// é‘„é€ æ™‚è¨­ç½®ç‚º falseï¼ŒVRFå›èª¿å¾Œè¨­ç½®ç‚º true
// ä½†æ‰€æœ‰æŸ¥è©¢å‡½æ•¸éƒ½ç§»é™¤äº† isRevealed æª¢æŸ¥
```

#### å½±éŸ¿åˆ†æ
- **å­˜å„²æˆæœ¬**ï¼šæ¯å€‹NFTå¤šå­˜å„²1å€‹boolï¼ˆ1 slot bitï¼‰
- **å‰ç«¯ä¾è³´**ï¼šå¯èƒ½æœ‰èˆŠçš„å‰ç«¯ä»£ç¢¼æª¢æŸ¥ isRevealed
- **å­åœ–ç´¢å¼•**ï¼šå¯èƒ½æœ‰ç›¸é—œçš„GraphQLæŸ¥è©¢

#### å»ºè­°è™•ç†æ–¹æ¡ˆ
```solidity
// æ–¹æ¡ˆAï¼šä¿ç•™å­—æ®µï¼Œå„ªåŒ–é‚è¼¯ï¼ˆæ¨è–¦ï¼‰âœ…
struct HeroData {
    uint8 rarity;
    uint256 power;
    // bool isRevealed; // ç§»é™¤è¨»é‡‹ï¼Œä¸å†å­˜å„²
}

// æ–¹æ¡ˆBï¼šæ·»åŠ å…¼å®¹æ€§å‡½æ•¸
function isRevealed(uint256 tokenId) external view returns (bool) {
    return true;  // å§‹çµ‚è¿”å›trueï¼Œä¿æŒæ¥å£å…¼å®¹
}
```

---

### 3ï¸âƒ£ **çå‹µé ˜å–ç³»çµ±ï¼ˆClaim Rewardsï¼‰**

#### ç•¶å‰ç‹€æ…‹
```solidity
// DungeonMaster.sol
function claimRewards(uint256 _partyId) external view {
    revert("DungeonMaster: Rewards are automatically deposited to PlayerVault");
}
```

#### å½±éŸ¿åˆ†æ
- **æ¥å£å…¼å®¹æ€§**ï¼šå…¶ä»–åˆç´„æˆ–å‰ç«¯å¯èƒ½ä»åœ¨èª¿ç”¨
- **ç”¨æˆ¶é«”é©—**ï¼šæä¾›æ˜ç¢ºçš„éŒ¯èª¤ä¿¡æ¯
- **Gasæµªè²»**ï¼šèª¿ç”¨æœƒæ¶ˆè€—gasä½†ç¸½æ˜¯å¤±æ•—

#### å»ºè­°è™•ç†æ–¹æ¡ˆ
```solidity
// æ–¹æ¡ˆAï¼šä¿ç•™ä¸¦å„ªåŒ–éŒ¯èª¤ä¿¡æ¯ï¼ˆæ¨è–¦ï¼‰âœ…
function claimRewards(uint256) external pure {  // æ”¹ç‚ºpureï¼Œç§»é™¤åƒæ•¸å
    revert("DEPRECATED: Rewards auto-deposit to PlayerVault");
}

// æ–¹æ¡ˆBï¼šå®Œå…¨ç§»é™¤ï¼ˆé«˜é¢¨éšªï¼‰
// å¯èƒ½ç ´å£ä¾è³´æ­¤å‡½æ•¸çš„å¤–éƒ¨èª¿ç”¨
```

---

### 4ï¸âƒ£ **æœªä½¿ç”¨çš„å‡½æ•¸åƒæ•¸**

#### ç•¶å‰å•é¡Œ
```solidity
// å¤šå€‹ä½ç½®çš„æœªä½¿ç”¨åƒæ•¸
function _performFailedUpgrade(
    address user,  // âš ï¸ æœªä½¿ç”¨
    uint256[] memory tokenIds,
    address tokenContract
)

function _determineRarityFromSeed(
    uint256 randomValue, 
    address user,      // âš ï¸ æœªä½¿ç”¨
    uint256 quantity   // âš ï¸ æœªä½¿ç”¨
)
```

#### å»ºè­°è™•ç†æ–¹æ¡ˆ
```solidity
// æ–¹æ¡ˆAï¼šä½¿ç”¨ä¸‹åŠƒç·šå‘½åï¼ˆæ¨è–¦ï¼‰âœ…
function _performFailedUpgrade(
    address /* user */,  // ä¿ç•™æ¥å£ä½†æ¨™è¨˜æœªä½¿ç”¨
    uint256[] memory tokenIds,
    address tokenContract
)

// æ–¹æ¡ˆBï¼šç§»é™¤åƒæ•¸ï¼ˆéœ€è¦æ›´æ–°æ‰€æœ‰èª¿ç”¨ï¼‰
function _determineRarityFromSeed(uint256 randomValue) 
    internal pure returns (uint8) 
{
    // ç°¡åŒ–çš„å¯¦ç¾
}
```

---

## ğŸ”„ å‰ç«¯ã€å­åœ–ã€å¾Œç«¯çš„éºç•™ä»£ç¢¼

### å‰ç«¯éºç•™
```typescript
// å¯èƒ½å­˜åœ¨çš„æª¢æŸ¥
if (hero.isRevealed) {  // æ°¸é ç‚ºtrue
    showHeroStats();
}

// ç–²å‹åº¦é¡¯ç¤º
<div>ç–²å‹åº¦: {party.fatigueLevel}</div>  // æ°¸é ç‚º0

// å„²å‚™è³¼è²·
<Button onClick={buyProvisions}>è³¼è²·å„²å‚™</Button>  // åŠŸèƒ½å·²ç§»é™¤
```

### å­åœ–éºç•™
```graphql
type Party @entity {
  provisionsRemaining: BigInt  # æœªä½¿ç”¨
  fatigueLevel: Int            # æœªä½¿ç”¨
}

type Hero @entity {
  isRevealed: Boolean          # æ°¸é true
}
```

### å¾Œç«¯éºç•™
```javascript
// Metadataç”Ÿæˆ
metadata.attributes.push({
  trait_type: "Revealed",
  value: hero.isRevealed ? "Yes" : "No"  // æ°¸é  "Yes"
});
```

---

## ğŸ›¡ï¸ å®‰å…¨è™•ç†ç­–ç•¥

### é«˜å„ªå…ˆç´šï¼ˆå¿…é ˆä¿ç•™ï¼‰
1. **æ•¸æ“šçµæ§‹å­—æ®µ**ï¼šéˆä¸Šå·²å­˜å„²çš„æ•¸æ“šçµæ§‹ä¸èƒ½æ”¹è®Š
2. **å¤–éƒ¨æ¥å£å‡½æ•¸**ï¼šå¯èƒ½è¢«å…¶ä»–åˆç´„èª¿ç”¨çš„public/externalå‡½æ•¸
3. **äº‹ä»¶å®šç¾©**ï¼šå·²ç™¼å‡ºçš„äº‹ä»¶ï¼Œå­åœ–ä¾è³´

### ä¸­å„ªå…ˆç´šï¼ˆè¬¹æ…è™•ç†ï¼‰
1. **å…§éƒ¨å‡½æ•¸åƒæ•¸**ï¼šå¯ä»¥å„ªåŒ–ä½†éœ€è¦æ›´æ–°æ‰€æœ‰èª¿ç”¨
2. **æœªä½¿ç”¨çš„å­˜å„²è®Šé‡**ï¼šæ–°æ•¸æ“šå¯ä»¥ä¸å­˜å„²ï¼ŒèˆŠæ•¸æ“šä¿ç•™
3. **å»¢æ£„çš„modifier**ï¼šç¢ºèªç„¡ä½¿ç”¨å¾Œå¯ç§»é™¤

### ä½å„ªå…ˆç´šï¼ˆå¯ä»¥æ¸…ç†ï¼‰
1. **ç§æœ‰å‡½æ•¸**ï¼šç¢ºèªå…§éƒ¨ç„¡èª¿ç”¨å³å¯ç§»é™¤
2. **è¨»é‡‹ä»£ç¢¼**ï¼šæ¸…ç†æ‰è¨»é‡‹çš„èˆŠä»£ç¢¼
3. **æ¸¬è©¦ä»£ç¢¼**ï¼šç§»é™¤ä¸»ç¶²ä¸éœ€è¦çš„æ¸¬è©¦å‡½æ•¸

---

## ğŸ“‹ æ¸…ç†è¨ˆåŠƒ

### ç¬¬ä¸€éšæ®µï¼šæ¨™è¨˜å»¢æ£„ï¼ˆç•¶å‰ç‰ˆæœ¬ï¼‰
```solidity
// æ·»åŠ å»¢æ£„æ¨™è¨˜
/// @deprecated æ­¤åŠŸèƒ½å·²å»¢æ£„ï¼Œä¿ç•™åƒ…ç‚ºå…¼å®¹æ€§
function claimRewards(uint256) external pure {
    revert("DEPRECATED");
}
```

### ç¬¬äºŒéšæ®µï¼šå„ªåŒ–å¯¦ç¾ï¼ˆå°ç‰ˆæœ¬æ›´æ–°ï¼‰
- å„ªåŒ–æœªä½¿ç”¨åƒæ•¸
- ç°¡åŒ–å…§éƒ¨é‚è¼¯
- æ›´æ–°å‰ç«¯å’Œå­åœ–

### ç¬¬ä¸‰éšæ®µï¼šç§»é™¤å»¢æ£„ï¼ˆå¤§ç‰ˆæœ¬æ›´æ–°ï¼‰
- éƒ¨ç½²æ–°ç‰ˆæœ¬åˆç´„
- é·ç§»æ•¸æ“š
- å®Œå…¨ç§»é™¤å»¢æ£„ä»£ç¢¼

---

## ğŸš€ ç«‹å³å¯åŸ·è¡Œçš„å„ªåŒ–

### 1. ç·¨è­¯è­¦å‘Šä¿®å¾©
```bash
# æ·»åŠ åƒæ•¸è¨»é‡‹
sed -i '' 's/address user,/address \/* user *\/,/g' contracts/current/core/AltarOfAscension.sol
sed -i '' 's/uint256 _partyId/uint256 \/* _partyId *\//g' contracts/current/core/DungeonMaster.sol
```

### 2. æ›´æ–°å‡½æ•¸å¯è¦‹æ€§
```solidity
// å°‡ view æ”¹ç‚º pureï¼ˆä¸è®€å–ç‹€æ…‹ï¼‰
function claimRewards(uint256) external pure {
    revert("DEPRECATED: Auto-deposit enabled");
}
```

### 3. æ¸…ç†è¨»é‡‹
```bash
# ç§»é™¤æ‰€æœ‰ TODO å’Œéæ™‚è¨»é‡‹
grep -r "TODO\|FIXME\|XXX" contracts/current/
```

---

## âš ï¸ é¢¨éšªè©•ä¼°

### ç§»é™¤ä»£ç¢¼çš„é¢¨éšª
| æ“ä½œ | é¢¨éšªç­‰ç´š | å½±éŸ¿ç¯„åœ | å»ºè­° |
|------|---------|---------|------|
| ç§»é™¤å­˜å„²è®Šé‡ | ğŸ”´ é«˜ | ç ´å£æ•¸æ“šä½ˆå±€ | âŒ ä¸è¦åŸ·è¡Œ |
| ç§»é™¤publicå‡½æ•¸ | ğŸ”´ é«˜ | ç ´å£å¤–éƒ¨èª¿ç”¨ | âŒ ä¸è¦åŸ·è¡Œ |
| ç§»é™¤äº‹ä»¶ | ğŸŸ¡ ä¸­ | å½±éŸ¿å­åœ– | âš ï¸ è¬¹æ… |
| å„ªåŒ–å…§éƒ¨å‡½æ•¸ | ğŸŸ¢ ä½ | åƒ…å½±éŸ¿gas | âœ… å¯ä»¥åŸ·è¡Œ |
| ç§»é™¤è¨»é‡‹ | ğŸŸ¢ ä½ | ç„¡å½±éŸ¿ | âœ… å¯ä»¥åŸ·è¡Œ |

---

## ğŸ“Š å½±éŸ¿è©•ä¼°ç¸½çµ

### å¦‚æœå®Œå…¨æ¸…ç†æ‰€æœ‰æ­»ä»£ç¢¼ï¼š
- **å„ªé»**ï¼š
  - æ¸›å°‘åˆç´„å¤§å°ï¼ˆç´„5-10%ï¼‰
  - é™ä½gasæ¶ˆè€—ï¼ˆç´„3-5%ï¼‰
  - æé«˜ä»£ç¢¼å¯è®€æ€§
  
- **ç¼ºé»**ï¼š
  - éœ€è¦é‡æ–°éƒ¨ç½²æ‰€æœ‰åˆç´„
  - éœ€è¦é·ç§»æ‰€æœ‰æ•¸æ“š
  - å¯èƒ½ç ´å£ç¬¬ä¸‰æ–¹é›†æˆ
  - éœ€è¦æ›´æ–°æ‰€æœ‰å‰ç«¯å’Œå­åœ–

### å»ºè­°æ–¹æ¡ˆï¼š
1. **çŸ­æœŸ**ï¼šä¿æŒç¾ç‹€ï¼Œåƒ…ä¿®å¾©ç·¨è­¯è­¦å‘Š
2. **ä¸­æœŸ**ï¼šæ¨™è¨˜å»¢æ£„ï¼Œå„ªåŒ–å¯¦ç¾
3. **é•·æœŸ**ï¼šV2ç‰ˆæœ¬å®Œå…¨é‡æ§‹

---

## ğŸ”§ å¯¦éš›åŸ·è¡Œå»ºè­°

### ç«‹å³åŸ·è¡Œï¼ˆç„¡é¢¨éšªï¼‰ï¼š
1. ä¿®å¾©ç·¨è­¯è­¦å‘Šï¼ˆä½¿ç”¨è¨»é‡‹åƒæ•¸ï¼‰
2. å„ªåŒ–å‡½æ•¸å¯è¦‹æ€§ï¼ˆview â†’ pureï¼‰
3. æ›´æ–°æ–‡æª”æ¨™è¨˜å»¢æ£„åŠŸèƒ½

### ä¸‹å€‹ç‰ˆæœ¬ï¼ˆä½é¢¨éšªï¼‰ï¼š
1. å„ªåŒ–å…§éƒ¨å‡½æ•¸å¯¦ç¾
2. ç§»é™¤æœªä½¿ç”¨çš„å…§éƒ¨è®Šé‡
3. ç°¡åŒ–é‚è¼¯æµç¨‹

### æœªä¾†ç‰ˆæœ¬ï¼ˆéœ€è¦è¨ˆåŠƒï¼‰ï¼š
1. è¨­è¨ˆæ–°çš„æ•¸æ“šçµæ§‹
2. å¯¦æ–½æ•¸æ“šé·ç§»æ–¹æ¡ˆ
3. éƒ¨ç½²å…¨æ–°çš„V2åˆç´„